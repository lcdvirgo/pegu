function Tile(a){this.x=a.x,this.y=a.y,this.n=a.n,this.isball=a.isball,this.istile=a.istile,this.n=a.n}function Grid(a,b){this.size=7,this.level=b,this.storage=a,this.cells=this.build()}function Display(){this.events={},this.availableMoves={up:!1,right:!1,down:!1,left:!1},this.moved=!1,this.tiles=[],this.score=0,this.init()}function LocalStorage(){this.levelID="levelID";var a=this.localStorageSupported();this.storage=a?window.localStorage:window.bkStorage}function Game(a){this.storage=new a,this.ison=!1,this.init()}Tile.prototype.updatePosition=function(a){this.x=a.x,this.y=a.y},Tile.prototype.addBall=function(){this.isball=!0},Tile.prototype.removeBall=function(){this.isball=!1},Tile.prototype.serialize=function(){return{n:this.n,isball:this.isball,istile:this.istile}},Grid.prototype.build=function(){for(var a=[],b=1,c=this.storage?this.storage.grid:this.level,d=0;d<this.size;d++)for(var e=a[d]=[],f=0;f<this.size;f++){var g={};g.isball=$.inArray(b,c.currentScheme)>=0&&$.inArray(b,c.emptySpots)<0?!0:!1,g.istile=$.inArray(b,c.currentScheme)>=0?!0:!1,g.n=b;var h=new Tile(g);e.push(h),b++}return a},Grid.prototype.serialize=function(){var a=[],b=[];return this.eachCell(function(c,d,e){e.istile&&a.push(e.n),e.isball||b.push(e.n)}),{currentScheme:a,emptySpots:b}},Grid.prototype.movesAvailable=function(a){var b={up:!1,right:!1,down:!1,left:!1},c=this,d=c.getTile(a);return this.eachCell(function(e,f){var g=c.cells[e][f];0==g.isball&&1==g.istile&&(g.n==a-2*c.size&&1==c.getTile(a-c.size).isball&&d.y==g.y?b.left=a-2*c.size:g.n==a+2*c.size&&1==c.getTile(a+c.size).isball&&d.y==g.y?b.right=a+2*c.size:g.n==a-2&&1==c.getTile(a-1).isball&&d.x==g.x?b.up=a-2:g.n==a+2&&1==c.getTile(a+1).isball&&d.x==g.x&&(b.down=a+2))}),b},Grid.prototype.eachCell=function(a){for(var b=0;b<this.size;b++)for(var c=0;c<this.size;c++)a(b,c,this.cells[b][c])},Grid.prototype.getTile=function(a){var b;return this.eachCell(function(c,d,e){e.n==a&&(b=e)}),b},Grid.prototype.moveTile=function(a,b){var c,d={};d.from_n=this.getTile(a),d.to_n=this.getTile(b),d.to_n.addBall(),d.from_n.removeBall(),b-2*this.size==a&&(c=b-this.size,d.eaten=this.getTile(c),d.eaten.removeBall()),b+2*this.size==a&&(c=b+this.size,d.eaten=this.getTile(c),d.eaten.removeBall()),b+2==a&&(c=b+1,d.eaten=this.getTile(c),d.eaten.removeBall()),b-2==a&&(c=b-1,d.eaten=this.getTile(c),d.eaten.removeBall());var e={to_n:d.to_n.n,from_n:d.from_n.n,eaten:d.eaten.n};return e},Display.prototype.tick=function(a){this.update&&(this.update=!1,this.stage.update(a))},Display.prototype.init=function(){var a=this,b=document.createElement("canvas");b.id="pegu",b.width=window.innerHeight,b.height=window.innerHeight,$("#canvasHolder").html(b),this.canvas=b,this.stage=new createjs.Stage(this.canvas),this.stage.enableMouseOver(10),this.stage.mouseMoveOutside=!0,this.container=new createjs.Container,this.stage.addChild(this.container),a.resize(),createjs.Touch.enable(this.stage),createjs.Ticker.addEventListener("tick",function(b){a.tick(b)}),window.alphaThresh=.75,$(window).resize(function(){a.resize()})},Display.prototype.resize=function(){var a=(window.innerWidth,window.innerHeight);this.canvas.width=a,this.canvas.height=a,this.container.x=0,this.container.y=0,this.w=a/(this.size||7),this.h=a/(this.size||7),this.ballw=a/(this.size||7)-6,this.ballh=a/(this.size||7)-6,this.update=!0},Display.prototype.on=function(a,b){this.events[a]||(this.events[a]=[]),this.events[a].push(b)},Display.prototype.emit=function(a,b){var c=this.events[a];c&&c.forEach(function(a){a(b)})},Display.prototype.moveTile=function(a){var b=this.tiles[a.eaten],c=this.tiles[a.from_n];this.tiles[a.to_n]=c,c.n=a.to_n,this.balls.removeChild(b)},Display.prototype.setAvailableMoves=function(a){this.availableMoves=a},Display.prototype.render=function(a){var b=this;b.container.removeAllChildren(),b.grid=a,b.board=new createjs.Container,b.container.addChild(this.board),b.balls=new createjs.Container,b.container.addChild(this.balls),b.size=a.size,window.requestAnimationFrame(function(){for(var c=0;c<a.cells.length;c++)for(var d=a.cells[c],e=0;e<d.length;e++){var f=d[e],g={};g.x=c*b.w,g.y=e*b.h,f.updatePosition(g),b.addNewTile(f),b.addNewBall(f)}})},Display.prototype.pressup=function(a){var b=this,c=a.target;if(c.scaleX=c.scaleY=c.scale,b.moved)b.moved=!1;else{var d=a.currentTarget;d.x=d.start.x,d.y=d.start.y}b.update=!0},Display.prototype.mousedown=function(a){var b=a.target;b.scaleX=b.scaleY=1.04*b.scale;var c=this,d=a.currentTarget;d.parent.addChild(d),d.offset={x:d.x-a.stageX,y:d.y-a.stageY},d.start={x:d.x,y:d.y},c.emit("mousedown",{x:d.x,y:d.y,n:d.n})},Display.prototype.pressmove=function(a){var b=this,c=a.currentTarget;if(b.availableMoves&&!b.moved){var d=!1,e=Math.abs(c.x-c.start.x),f=Math.abs(c.y-c.start.y),g=4;if(e>g||f>g)if(e>f){if(b.availableMoves.left&&c.x<=c.start.x){var h=b.grid.getTile(b.availableMoves.left);c.x=a.stageX+c.offset.x,c.y=h.y,c.x<h.x+b.w/2&&(d=!0)}if(b.availableMoves.right&&c.x>=c.start.x){var h=b.grid.getTile(b.availableMoves.right);c.x=a.stageX+c.offset.x,c.y=h.y,c.x>h.x-b.w/2&&(d=!0)}}else{if(b.availableMoves.down&&c.y>=c.start.y){var h=b.grid.getTile(b.availableMoves.down);c.y=a.stageY+c.offset.y,c.x=h.x,c.y>h.y-b.h/2&&(d=!0)}if(b.availableMoves.up&&c.y<=c.start.y){var h=b.grid.getTile(b.availableMoves.up);c.y=a.stageY+c.offset.y,c.x=h.x,c.y<h.y+b.h/2&&(d=!0)}}else c.y=a.stageY+c.offset.y,c.x=a.stageX+c.offset.x;d&&(b.emit("pressup",{n:c.n,to_n:h.n}),c.x=h.x,c.y=h.y,b.moved=!0)}b.update=!0,b.selected=c},Display.prototype.rollover=function(a){var b=this,c=a.target;c.scaleX=c.scaleY=c.scale,b.update=!0},Display.prototype.rollout=function(a){var b=this,c=a.target;c.scaleX=c.scaleY=c.scale,b.update=!0},Display.prototype.addNewBall=function(a){var b=this;if(a.isball&&a.istile){var c=(new createjs.Graphics).beginFill("rgba(255,255,255,1)").drawRoundRect(0,0,b.ballw,b.ballh,5),d=new createjs.Shape(c);d.x=b.w/2,d.y=b.h/2,d.scale=1,d.regX=b.ballw/2,d.regY=b.ballh/2;var e=new createjs.Container;e.addChild(d),e.name="ball_"+a.n,e.x=a.x,e.y=a.y,e.n=a.n,e.cursor="pointer",this.tiles[a.n]=e,b.balls.addChild(e),e.addEventListener("pressup",function(a){b.pressup(a)}),e.addEventListener("mousedown",function(a){b.mousedown(a)}),e.addEventListener("pressmove",function(a){b.pressmove(a)}),d.addEventListener("rollover",function(a){b.rollover(a)}),d.addEventListener("rollout",function(a){b.rollout(a)})}},Display.prototype.addNewTile=function(a){var b=this,c=new createjs.Container;if(c.name="square_"+a.n,a.istile){var d=(new createjs.Graphics).beginFill("rgba(240,117,110,1)").drawRoundRect(0,0,b.w,b.h,2),e=new createjs.Shape(d);c.x=a.x,c.y=a.y,c.addChild(e),b.board.addChild(c)}b.update=!0},window.bkStorage={_data:{},setItem:function(a,b){return this._data[a]=String(b)},getItem:function(a){return this._data.hasOwnProperty(a)?this._data[a]:void 0},removeItem:function(a){return delete this._data[a]},clear:function(){return this._data={}}},LocalStorage.prototype.localStorageSupported=function(){var a="test",b=window.localStorage;try{return b.setItem(a,"1"),b.removeItem(a),!0}catch(c){return!1}},LocalStorage.prototype.getBestScore=function(){return this.storage.getItem(this.bestScoreKey)||0},LocalStorage.prototype.setBestScore=function(a){this.storage.setItem(this.bestScoreKey,a)},LocalStorage.prototype.setLevelID=function(a){this.storage.setItem(this.levelID,a)},LocalStorage.prototype.getLevelID=function(){return this.storage.getItem(this.levelID)||0},LocalStorage.prototype.clearLevel=function(){this.storage.removeItem("game_level_"+this.getLevelID())},LocalStorage.prototype.getLevel=function(a){var b=this.storage.getItem("game_level_"+a);return b?JSON.parse(b):null},LocalStorage.prototype.setLevel=function(a){var b="game_level_"+a.level;this.storage.setItem(b,JSON.stringify(a))},LocalStorage.prototype.setGameStatus=function(a){this.storage.setItem("gameStatus",a)},LocalStorage.prototype.getGameStatus=function(){return this.storage.getItem("gameStatus")||0},Game.prototype.mousedown=function(a){var b=this.grid.movesAvailable(a.n);this.display.setAvailableMoves(b)},Game.prototype.pressup=function(a){var b=this.grid.moveTile(a.n,a.to_n);b&&this.display.moveTile(b)},Game.prototype.pressmove=function(){},Game.prototype.init=function(){this.levels=this.readLevels(),this.levelID=this.storage.getLevelID(),this.display=new Display,this.display.on("mousedown",this.mousedown.bind(this)),this.display.on("pressup",this.pressup.bind(this))},Game.prototype.readLevels=function(){var a;return $.ajax({url:"levels/levels.json",success:function(b){a=b},async:!1}),a},Game.prototype.render=function(){this.levelID=this.levelID<0?this.levels.length-1:this.levelID,this.levelID=this.levels[this.levelID]?this.levelID:0,this.storage.setLevelID(this.levelID);var a=this.storage.getLevel(this.levelID);this.grid=new Grid(a,this.levels[this.levelID]),this.display.render(this.grid,{score:a?a.score:0})},Game.prototype.getGameStatus=function(){return this.storage.getGameStatus()},Game.prototype.start=function(){this.storage.setGameStatus(1),this.render()},Game.prototype.restart=function(){this.storage.clearLevel(),this.render()},Game.prototype.nextLevel=function(){this.saveState(),this.levelID++,this.render()},Game.prototype.previousLevel=function(){this.saveState(),this.levelID--,this.render()},Game.prototype.saveState=function(){this.grid&&this.storage.setLevel({grid:this.grid.serialize(),score:1,level:this.levelID})},jQuery(document).ready(function(a){var b=new Game(LocalStorage);1==b.getGameStatus()?(a("header").hide(),a("#info").show("500"),b.start()):(a("header").show("500"),a("#info").hide("500")),a(".play a").on("click",function(c){c.preventDefault(),a("header").hide("500"),a("#info").show("500"),1==b.getGameStatus()||b.start()}),a("#infobtn").on("click",function(b){b.preventDefault(),a("header").show("500"),a("#info").hide("500")}),a("#refresh").on("click",function(a){a.preventDefault(),b.restart()}),a("#next").on("click",function(a){a.preventDefault(),b.nextLevel()}),a("#previous").on("click",function(a){a.preventDefault(),b.previousLevel()}),a(window).unload(function(){b.saveState()})});